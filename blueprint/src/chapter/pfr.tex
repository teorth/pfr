\chapter{Proof of PFR}

\begin{lemma}[Ruzsa covering lemma]
\label{ruz-cov}
\lean{Finset.ruzsa_covering_mul}
\leanok
If $A,B$ are finite non-empty subsets of a group $G$, then $A$ can be covered by at most $|A+B|/|B|$ translates of $B-B$.
\end{lemma}
\begin{proof}
\leanok
Cover $A$ greedily by disjoint translates of $B$.
\end{proof}

\begin{lemma}\label{pfr_aux}
  \lean{PFR_conjecture_aux}\leanok If $A \subset {\bf F}_2^n$ is non-empty and
  $|A+A| \leq K|A|$, then $A$ can be covered by at most $K ^
  {13/2}|A|^{1/2}/|H|^{1/2}$ translates of a subspace $H$ of ${\bf F}_2^n$ with
  \begin{equation}
    \label{ah}
    |H|/|A| \in [K^{-11}, K^{11}].
  \end{equation}
  \end{lemma}

\begin{proof}
\uses{entropy-pfr, unif-exist, uniform-entropy-II, jensen-bound,ruz-dist-def,ruzsa-diff,bound-conc,ruz-cov}\leanok
  Let $U_A$ be the uniform distribution on $A$ (which exists by \Cref{unif-exist}), thus $\bbH[U_A] = \log |A|$ by \Cref{uniform-entropy-II}. By \Cref{jensen-bound} and the fact that $U_A + U_A$ is supported on $A + A$, $\bbH[U_A + U_A] \leq \log|A+A|$. By \Cref{ruz-dist-def}, the doubling condition $|A+A| \leq K|A|$ therefore gives
  \[d[U_A;U_A] \leq \log K.\]
  By \Cref{entropy-pfr}, we may thus find a subspace $H$ of $\F_2^n$ such that
  \begin{equation}\label{uauh} d[U_A;U_H] \leq \tfrac{1}{2} C' \log K\end{equation}
  with $C' = 11$.
  By \Cref{ruzsa-diff} we conclude that
  \begin{equation*}
    |\log |H| - \log |A|| \leq C' \log K,
  \end{equation*}
  proving~\eqref{ah}.
  From \Cref{ruz-dist-def},~\eqref{uauh} is equivalent to
  \[\bbH[U_A - U_H] \leq \log( |A|^{1/2} |H|^{1/2}) + \tfrac{1}{2} C' \log K.\]
  By \Cref{bound-conc} we conclude the existence of a point $x_0 \in \F_p^n$ such that
  \[p_{U_A-U_H}(x_0) \geq |A|^{-1/2} |H|^{-1/2} K^{-C'/2},\]
  or equivalently
  \[|A \cap (H + x_0)| \geq K^{-C'/2} |A|^{1/2} |H|^{1/2}.\]
  Applying \Cref{ruz-cov}, we may thus cover $A$ by at most
  \[\frac{|A + (A \cap (H+x_0))|}{|A \cap (H + x_0)|} \leq \frac{K|A|}{K^{-C'/2} |A|^{1/2} |H|^{1/2}} = K^{C'/2+1} \frac{|A|^{1/2}}{|H|^{1/2}}\]
  translates of
  \[\bigl(A \cap (H + x_0)\bigr) - \bigl(A \cap (H + x_0)\bigr) \subseteq H.\]
  This proves the claim.
\end{proof}


\begin{theorem}[PFR]\label{pfr}
\lean{PFR_conjecture}\leanok
If $A \subset {\bf F}_2^n$ is non-empty and $|A+A| \leq K|A|$, then $A$ can be covered by most $2K^{12}$ translates of a subspace $H$ of ${\bf F}_2^n$ with $|H| \leq |A|$.
\end{theorem}

\begin{proof}
  \uses{pfr_aux}\leanok
  Let $H$ be given by \Cref{pfr_aux}.
  If $|H| \leq |A|$ then we are already done thanks to~\eqref{ah}.  If $|H| > |A|$ then we can cover $H$ by at most $2 |H|/|A|$ translates of a subspace $H'$ of $H$ with $|H'| \leq |A|$.  We can thus cover $A$ by at most
  \[2K^{13/2} \frac{|H|^{1/2}}{|A|^{1/2}}\]
  translates of $H'$, and the claim again follows from~\eqref{ah}.
\end{proof}

\begin{corollary}[PFR in infinite groups]\label{pfr-cor}
  \lean{PFR_conjecture'}\leanok
  If $G$ is an abelian $2$-torsion group, $A \subset G$ is non-empty finite, and $|A+A| \leq K|A|
  $, then $A$ can be covered by most $2K^{12}$ translates of a finite group  $H$ of $G$ with $|H| \leq |A|$.
  \end{corollary}

\begin{proof}\uses{pfr}\leanok  Apply \Cref{pfr} to the group generated by $A$, which is isomorphic to $\F_2^n$ for some $n$.
\end{proof}
